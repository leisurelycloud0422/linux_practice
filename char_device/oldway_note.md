## ğŸ“‘ ç›®éŒ„
- **Linux è£¡çš„ Device**
    - **Character Device**
    - **Block Device**
- **/dev/mydev**
- **cdev**
    - **register_chrdev**
    - **alloc + cdev_init + cdev_add**
- **file_operations**
- **é‡è¦æŒ‡ä»¤** 
<br><br>

## ğŸ”¥Linux è£¡çš„ Deviceï¼ˆè£ç½®ï¼‰

åœ¨ Linux è£¡ï¼Œ**è£ç½®ï¼ˆDeviceï¼‰** æ˜¯ç”¨ä¾†è·Ÿç¡¬é«”äº’å‹•çš„æŠ½è±¡ä»‹é¢ã€‚

Linux æ¡ç”¨ã€Œ**ä¸€åˆ‡çš†æª”æ¡ˆ**ã€çš„è¨­è¨ˆï¼ŒæŠŠè£ç½®ç•¶æˆä¸€ç¨®æª”æ¡ˆï¼ˆè£ç½®æª”ï¼‰ï¼Œæ”¾åœ¨ `/dev/` ç›®éŒ„ä¸‹ï¼Œä¾‹å¦‚ï¼š

- `/dev/tty` â†’ çµ‚ç«¯æ©Ÿ
- `/dev/sda` â†’ ç¡¬ç¢Ÿ

é€™äº›è£ç½®å¤§è‡´å¯ä»¥åˆ†ç‚º **å…©å¤§é¡**ï¼š

## 1. å­—å…ƒè£ç½®ï¼ˆCharacter Deviceï¼‰

- **å‚³è¼¸æ–¹å¼**
    - ä¸€æ¬¡è®€å¯«ä¸€å€‹ã€Œå­—å…ƒï¼ˆbyteï¼‰ã€æˆ–ä¸€ä¸²ä½å…ƒçµ„
    - è³‡æ–™æ˜¯ç·šæ€§å‚³è¼¸ã€æŒ‰é †åºæµå‹•çš„
**ç‰¹é»**

- **ä¸æ”¯æ´éš¨æ©Ÿå­˜å–** â†’ ä¸èƒ½åƒæª”æ¡ˆä¸€æ¨£ã€Œseek åˆ°æŸå€‹ä½ç½®ã€
- é©åˆ **è³‡æ–™é‡å°ã€é€£çºŒå‚³è¼¸** çš„æ‡‰ç”¨
- ç¯„ä¾‹ï¼šéµç›¤è¼¸å…¥è³‡æ–™æ˜¯ã€Œä¸€å€‹ä¸€å€‹å­—å…ƒã€é€é€²ä¾†çš„

## 2. å€å¡Šè£ç½®ï¼ˆBlock Deviceï¼‰

- **å‚³è¼¸æ–¹å¼**
    - ä»¥ã€Œå€å¡Šï¼ˆblockï¼‰ã€ç‚ºå–®ä½ï¼ˆé€šå¸¸ 512 bytes æˆ– 4KBï¼‰
    - æ”¯æ´ **éš¨æ©Ÿå­˜å–ï¼ˆrandom accessï¼‰**
- **ç‰¹é»**
    - æ”¯æ´ **æª”æ¡ˆç³»çµ±ï¼ˆext4ã€FAT...ï¼‰**
    - é©åˆ **å¤§é‡è³‡æ–™** æˆ– **éš¨æ©Ÿå­˜å–** çš„æ‡‰ç”¨
<br>
 

## ğŸ”¥`/dev/mydev` æ˜¯ä»€éº¼ï¼Ÿ

- `/dev/mydev` æ˜¯ä¸€å€‹ **è£ç½®ç¯€é»ï¼ˆdevice nodeï¼‰**ï¼Œåˆç¨± **ç‰¹æ®Šæª”æ¡ˆ**ã€‚
- å®ƒæ˜¯ä½¿ç”¨è€…ç¨‹å¼èˆ‡æ ¸å¿ƒé©…å‹•ç¨‹å¼ä¹‹é–“çš„ **æ©‹æ¨‘**ã€‚
- é€éå®ƒï¼Œä½¿ç”¨è€…å¯ä»¥ç”¨ `cat`ã€`echo`ã€`read`ã€`write` ç­‰æ–¹å¼æ“ä½œç¡¬é«”ï¼Œè€Œä¸ç”¨ç›´æ¥æ¥è§¸ç¡¬é«”å¯„å­˜å™¨ã€‚

> å¯ä»¥æŠŠå®ƒæƒ³åƒæˆã€Œé©…å‹•ç¨‹å¼çš„å…¥å£é–€æˆ¶ã€
<br>


## ğŸ”¥cdev

åœ¨ Linux ä¸­ï¼Œcdevï¼ˆcharacter device objectï¼‰æ˜¯ **VFS èˆ‡ä½ çš„ driver ä¹‹é–“çš„çœŸæ­£æ©‹æ¢**ã€‚

è¦è®“ `/dev/mydev` èƒ½å‘¼å«åˆ°ä½ çš„ `open/read/write`ï¼Œå°±éœ€è¦å»ºç«‹ cdevã€‚

å»ºç«‹ cdev ä¹Ÿæœ‰ **å…©ç¨®æ–¹å¼**ï¼š

### æ–¹æ³•ä¸€ï¼šèˆŠå¼å»ºç«‹æ–¹å¼ï¼ˆä½¿ç”¨ register_chrdevï¼‰

#### âœ” ä¸éœ€è¦æ‰‹å‹•å‰µå»º cdev

`register_chrdev()` æœƒï¼š

- åˆ†é… major number
- **è‡ªå‹•å…§éƒ¨å»ºç«‹ä¸€å€‹ cdev**
- å°‡ file_operations ç¶å®šä¸Šå»

#### âœ” ç¼ºé»

- ç„¡æ³•æŒ‡å®š minor numberï¼ˆåªæ”¯æ´ä¸€å€‹ minor=0ï¼‰
- ä¸å¥½ç®¡ç†
- ä¸æ¨è–¦åœ¨åµŒå…¥å¼æˆ–ç”¢å“ä½¿ç”¨ï¼ˆå·²è¢«è¦–ç‚º legacyï¼‰
<br>

### æ–¹æ³•äºŒï¼šç¾ä»£æ¨™æº–æµç¨‹ï¼ˆalloc + cdev_init + cdev_addï¼‰

#### âœ” éœ€è¦ä½ æ‰‹å‹•å»ºç«‹ cdev

ç¾ä»£ Linux driver çš„æ¨™æº–æ–¹æ³•ï¼š

1. **alloc_chrdev_region()**
    
    â†’ åˆ†é… major/minor number
    
2. **cdev_init()**
    
    â†’ åˆå§‹åŒ– cdev objectï¼Œå°‡ file_operations ç¶ä¸Š
    
3. **cdev_add()**
    
    â†’ æ­£å¼æŠŠ cdev è¨»å†Šåˆ° kernelï¼ˆè®“ VFS å¯ä»¥æ“ä½œï¼‰
    

#### âœ” å„ªé»

- å¤šå€‹ minorï¼ˆæ”¯æ´å¤šè£ç½®ï¼‰
- å®Œå…¨æ§åˆ¶ lifecycle
- æ‰€æœ‰æ­£å¼ kernel driver éƒ½ä½¿ç”¨é€™æ–¹å¼

| åŠŸèƒ½ | register_chrdev() | alloc_chrdev_region() + cdev_init() + cdev_add()ï¼ˆç¾ä»£å¯«æ³•ï¼‰ |
| --- | --- | --- |
| major/minor | **åªèƒ½ç”³è«‹ä¸€å€‹ majorã€æ‰€æœ‰ minor** | å‹•æ…‹ç”³è«‹ majorï¼Œ**å¯ä»¥é¸æ“‡ä½¿ç”¨å¤šå°‘ minor** |
| cdev ç®¡ç† | kernel è‡ªå‹•å»ºç«‹åŒ¿å cdevï¼Œ**ä½ ç„¡æ³•ç®¡ç†** | è‡ªå·±å»ºç«‹ cdevï¼Œ**å®Œå…¨æ§åˆ¶** |
| æ”¯æ´å¤šè£ç½® | å¾ˆé›£ï¼ˆå›ºå®šä¸€å€‹ majorï¼‰ | å¯ä»¥ç®¡ç†å¤šå€‹ minorï¼Œéå¸¸é©åˆå¤šè£ç½® driver |
| udev æ•´åˆ | è¼ƒèˆŠã€ä¸æ¨è–¦ | èˆ‡ device_create()/class_create() æ­é…æœ€å¸¸ç”¨ |
| æ˜¯å¦éæ™‚ | **è€èˆŠ APIï¼Œä¸æ¨è–¦** | **ç›®å‰ kernel å®˜æ–¹æ¨è–¦ä½¿ç”¨** |  
<br>


## `struct file_operations`   
- `struct file_operations`ï¼ˆç°¡ç¨± **fops**ï¼‰æ˜¯ Linux æ ¸å¿ƒæä¾›çš„ä¸€å€‹çµæ§‹ï¼Œç”¨ä¾†æè¿° **è£ç½®ï¼ˆdeviceï¼‰å¯æ”¯æ´çš„æ“ä½œ**ã€‚
- æ¯å€‹å­—å…ƒè£ç½®æˆ–å€å¡Šè£ç½®éƒ½å¯ä»¥é€éå®ƒï¼Œè®“æ ¸å¿ƒçŸ¥é“ä½¿ç”¨è€…ç¨‹å¼å° `/dev/<device>` åšçš„æ“ä½œè¦å‘¼å«å“ªå€‹å‡½å¼ã€‚

```c
struct file_operations fops = {
    .open = my_open,
    .release = my_release,
    .read = mydev_read,
    .write = mydev_write,
};

```

æŠŠ 4 å€‹è¡Œç‚ºè¨»å†Šé€² kernelã€‚
**æ¯æ¬¡ä½¿ç”¨è€…å° `/dev/mydev` åš I/O æ™‚ï¼Œkernel å°±æœƒå‘¼å«å¯¦ä½œçš„é€™äº›å‡½å¼ã€‚**  
#### ğŸ§© 1. open()
æ­¤ç¯„ä¾‹åªç°¡å–®å°è¨Šæ¯, ä½†ä¸€èˆ¬ driver æœƒåšï¼š

âœ” åˆå§‹åŒ– private_data

âœ” åˆ†é…æš«å­˜ buffer

âœ” è¨ˆæ•¸ä½¿ç”¨è€…æ•¸é‡

âœ” åˆå§‹åŒ–ç¡¬é«”ï¼ˆI2C deviceã€GPIOã€SPI ç­‰ï¼‰

#### ğŸ§© 2. release()
é€šå¸¸åšï¼š

âœ” å›æ”¶è³‡æº

âœ” free ç§æœ‰è³‡æ–™

âœ” æŠŠè£ç½®è¨­å®šå›å®‰å…¨ç‹€æ…‹

âœ” æ¸›å°‘ä½¿ç”¨è€…å¼•ç”¨è¨ˆæ•¸ï¼ˆä¾‹å¦‚ç”¨åœ¨å¤šé–‹æ§åˆ¶ï¼‰  
<br>

## é‡è¦æŒ‡ä»¤
### `copy_to_user()` â€” è®€è³‡æ–™çµ¦ä½¿ç”¨è€…

```
copy_to_user(buf, device_buffer + *ppos, count);
```

- å°‡ `device_buffer` çš„è³‡æ–™è¤‡è£½åˆ°ä½¿ç”¨è€…æä¾›çš„ `buf`
- å¾ `ppos` åç§»é–‹å§‹ï¼Œè¤‡è£½ `count` å€‹ byte
- å¸¸ç”¨æ–¼ `read()` å‡½å¼
<br>


### `copy_from_user()` â€” å¾ä½¿ç”¨è€…å–å¾—è³‡æ–™

```
copy_from_user(device_buffer, user_buf, count);
```

- å°‡ä½¿ç”¨è€…æä¾›çš„ `user_buf` è¤‡è£½åˆ° kernel çš„ `device_buffer`
- å¸¸ç”¨æ–¼ `write()` å‡½å¼
<br>


### `register_chrdev()` â€” è¨»å†Šå­—å…ƒè£ç½®

#### åŸå‹

```c
int register_chrdev(unsigned int major, const char *name, const struct file_operations *fops);
```

#### åŠŸèƒ½

- è¨»å†Šä¸€å€‹ **ç°¡å–®çš„å­—å…ƒè£ç½®**ï¼Œä¸éœ€è¦å»ºç«‹ device class æˆ–ä½¿ç”¨ udev
- è®“æ ¸å¿ƒçŸ¥é“é€™å€‹å­—å…ƒè£ç½®çš„ **ä¸»è¨­å‚™è™Ÿ (major number)** èˆ‡å°æ‡‰çš„ **æ“ä½œå‡½å¼è¡¨ (`file_operations`)**
<br>

### `unregister_chrdev()` â€” ç§»é™¤å­—å…ƒè£ç½®

#### åŸå‹

```
void unregister_chrdev(unsigned int major, const char *name);
```

#### åŠŸèƒ½

- ç§»é™¤å…ˆå‰ç”¨ `register_chrdev()` è¨»å†Šçš„å­—å…ƒè£ç½®
- é‡‹æ”¾ **ä¸»è¨­å‚™è™Ÿ (major number)**ï¼Œé¿å…è³‡æºæ´©æ¼
- `name` å¿…é ˆèˆ‡è¨»å†Šæ™‚ä½¿ç”¨çš„åç¨±ç›¸åŒ

âœ… **é‡é»**ï¼š

- ä½¿ç”¨ `major=0` å¯è®“æ ¸å¿ƒè‡ªå‹•åˆ†é…ç©ºé–’çš„ major number
- è¨»å†ŠæˆåŠŸå¾Œï¼Œå¯ä»¥ç”¨ mknod å»ºç«‹ `/dev/<name>` é€²è¡Œæ“ä½œ
- å¸è¼‰æ¨¡çµ„æˆ–çµæŸä½¿ç”¨æ™‚ï¼Œä¸€å®šè¦å‘¼å« `unregister_chrdev()`
<br>



### `sudo mknod /dev/mydev c 240 0`  
```bash
# å‡è¨­ major æ˜¯ 240ï¼Œå‰µå»ºè£ç½®ç¯€é»
sudo mknod /dev/mydev c 240 0
```

- **mknod**ï¼šç”¨ä¾†åœ¨ `/dev` ä¸‹æ‰‹å‹•å‰µå»ºä¸€å€‹è¨­å‚™ç¯€é» (device file)ã€‚
- `/dev/mydev`ï¼šè£ç½®æª”æ¡ˆçš„åç¨±ã€‚
- **c**ï¼šè¡¨ç¤ºé€™æ˜¯ **å­—å…ƒè£ç½® (character device)**ã€‚
- `240`ï¼šé€™æ˜¯ **ä¸»è¨­å‚™è™Ÿ (major number)**ï¼Œå®ƒå‘Šè¨´ Linux é€™å€‹è£ç½®è¦äº¤çµ¦å“ªå€‹é©…å‹•ç¨‹å¼è™•ç†ã€‚
- `0`ï¼šé€™æ˜¯ **æ¬¡è¨­å‚™è™Ÿ (minor number)**ï¼Œé€šå¸¸ç”¨ä¾†å€åˆ†åŒä¸€é¡è£ç½®ä¸‹çš„ä¸åŒå¯¦ä¾‹ã€‚














