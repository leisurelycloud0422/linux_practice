## ğŸ“‘ ç›®éŒ„
- **Device**
- **/dev/mydev**
- **cdev**
- **udev**
- **å¦‚ä½•å‰µå»º /dev/mydevï¼Ÿ**
- **å¦‚ä½•å‰µå»º cdevï¼Ÿ**
- **é‡è¦æŒ‡ä»¤**  

## Device
åœ¨ Linux è£¡ï¼ŒDeviceæ˜¯ç”¨ä¾†è·Ÿç¡¬é«”äº’å‹•çš„æŠ½è±¡ä»‹é¢ã€‚Linux æœƒæŠŠè£ç½®ç•¶æˆä¸€ç¨®æª”æ¡ˆï¼ˆè£ç½®æª”ï¼‰ï¼Œä¾‹å¦‚ /dev/ttyã€/dev/sdaã€‚é€™äº›è£ç½®å¤§è‡´å¯ä»¥åˆ†ç‚ºå…©é¡  
#### 1.å­—å…ƒè£ç½®ï¼ˆCharacter Deviceï¼‰  
  å‚³è¼¸æ–¹å¼ :ä¸€æ¬¡è®€å¯«ä¸€å€‹ã€Œå­—å…ƒï¼ˆbyteï¼‰ã€æˆ–ä¸€ä¸²ä½å…ƒçµ„ã€‚è³‡æ–™æ˜¯ç·šæ€§å‚³è¼¸ã€æŒ‰é †åºæµå‹•çš„  
  å¸¸è¦‹ç¯„ä¾‹ ï¼šéµç›¤ã€æ»‘é¼ ã€åºåˆ—åŸ ï¼ˆserial portï¼Œä¾‹å¦‚ /dev/ttyS0ï¼‰ã€GPIO æ§åˆ¶å™¨  
  é–‹ç™¼æ–¹å¼ ï¼šé€é Linux æ ¸å¿ƒæä¾›çš„ file_operations çµæ§‹ï¼Œå¯¦ä½œ read()ã€write()ã€open() ç­‰å‡½å¼ä¾†æ“ä½œè£ç½®  
  ç‰¹é»     ï¼šè³‡æ–™ä¸æ”¯æ´éš¨æ©Ÿå­˜å–ï¼ˆä¸èƒ½ã€Œè·³åˆ°æŸä¸€å€‹ä½ç½®ã€è®€è³‡æ–™ï¼‰ï¼Œé©åˆè³‡æ–™é‡å°ã€å–®å‘ã€é€£çºŒçš„è¼¸å…¥/è¼¸å‡º  
#### 2.å€å¡Šè£ç½®ï¼ˆBlock Deviceï¼‰
  å‚³è¼¸æ–¹å¼ ï¼šä»¥ã€Œå€å¡Šï¼ˆblockï¼‰ã€ç‚ºå–®ä½ï¼Œä¸€æ¬¡è®€å¯«ä¸€æ•´å¡Šè³‡æ–™ï¼ˆé€šå¸¸æ˜¯ 512 bytes æˆ– 4KBï¼‰ã€‚è³‡æ–™å¯ä»¥ä»»æ„å­˜å–ï¼ˆrandom accessï¼‰  
  å¸¸è¦‹ç¯„ä¾‹ ï¼šç¡¬ç¢Ÿï¼ˆHDD / SSDï¼Œä¾‹å¦‚ /dev/sdaï¼‰ã€è¨˜æ†¶å¡ã€USB å„²å­˜è£ç½®ã€RAM disk  
  é–‹ç™¼æ–¹å¼ ï¼šé€éè¼ƒè¤‡é›œçš„ APIï¼ˆå¦‚ block_device_operationsï¼‰ï¼Œé…åˆç³»çµ±çš„cache æ©Ÿåˆ¶é€²è¡Œè³‡æ–™äº¤æ›  
  ç‰¹é» ï¼šæ”¯æ´æª”æ¡ˆç³»çµ±ï¼ˆext4ã€FAT ç­‰ï¼‰ï¼Œé©åˆå¤§é‡è³‡æ–™è®€å¯«èˆ‡éš¨æ©Ÿå­˜å–æ‡‰ç”¨  
<br><br>
## /dev/mydev
- `/dev/mydev` æ˜¯ä¸€å€‹ **è£ç½®ç¯€é»ï¼ˆdevice nodeï¼‰**ï¼Œåˆç¨± **ç‰¹æ®Šæª”æ¡ˆ**
- å®ƒæ˜¯ä½¿ç”¨è€…ç¨‹å¼èˆ‡æ ¸å¿ƒé©…å‹•ç¨‹å¼ä¹‹é–“çš„ **æ©‹æ¨‘**  
- é€éå®ƒï¼Œä½¿ç”¨è€…å¯ä»¥ç”¨ `cat`ã€`echo`ã€`read`ã€`write` ç­‰æ–¹å¼æ“ä½œç¡¬é«”ï¼Œè€Œä¸ç”¨ç›´æ¥æ¥è§¸ç¡¬é«”å¯„å­˜å™¨ã€‚
- é€™å€‹ç¯€é»æœ¬è³ªä¸Šæ˜¯ä¸€å€‹ã€ŒæŒ‡å‘é©…å‹•ç¨‹å¼çš„å…¥å£ã€


## cdev
###  **cdev æ˜¯ Kernel å…§éƒ¨çš„ã€Œå­—å…ƒè£ç½®æ¨¡å‹ã€**

ğŸ“Œ **å±¬æ–¼ Kernel è£¡çš„è³‡æ–™çµæ§‹ï¼Œç”¨ä¾†ä»£è¡¨ä¸€å€‹ character deviceï¼ˆå­—å…ƒè£ç½®ï¼‰ã€‚**

ä½ åœ¨ kernel module è£¡æœƒå¯«ï¼š

- **cdev_init()** â†’ åˆå§‹åŒ–ä¸€å€‹ `struct cdev`
- **cdev_add()** â†’ æŠŠé€™å€‹ cdev è¨»å†Šåˆ° Linux VFS ç³»çµ±
- Linux æ‰çŸ¥é“é€™å€‹ â€œè¨­å‚™ç¯€é»èƒŒå¾Œæ˜¯å“ªå€‹ driver çš„ read/write/openâ€

ğŸ‘‰ **cdev åƒ…å­˜åœ¨æ–¼ kernel å…§ï¼Œè·Ÿä½¿ç”¨è€…ç©ºé–“ç„¡é—œï¼**

#### ğŸ“Œ cdev çš„åŠŸèƒ½

- å®šç¾©é€™å€‹å­—å…ƒè£ç½®çš„è¡Œç‚ºï¼ˆread/write/open/releaseï¼‰
- æä¾› `/dev/mydev` èƒŒå¾ŒçœŸæ­£çš„ driver ä»‹é¢
- åœ¨ VFS æ¶æ§‹ä¸­è¨»å†Šä¸€å€‹å¯æ“ä½œçš„ device

#### âœ” cdev = Kernel ç”¨ä¾†ç®¡ç†å­—å…ƒè£ç½®çš„è³‡æ–™çµæ§‹èˆ‡è¡Œç‚ºã€‚è·Ÿ /dev/nodeã€ä½¿ç”¨è€…ç©ºé–“ç„¡é—œã€‚  


## udev
###  **udev æ˜¯ User Space çš„ã€Œè‡ªå‹•å‰µå»º /dev æª”æ¡ˆçš„å®ˆè­·ç¨‹å¼ã€**

ğŸ“Œ **udev æ˜¯ Linux ä½¿ç”¨è€…ç©ºé–“çš„ç³»çµ±æœå‹™ï¼ˆdaemonï¼‰**

å®ƒè² è²¬ï¼š

- ç›£æ§ kernel ç™¼å‡ºçš„ uevent
- è‡ªå‹•å»ºç«‹ /dev/xxx ç¯€é»ï¼ˆä¸ç”¨ä½ æ‰‹å‹• mknodï¼‰
- è¨­å®š device æ¬Šé™ï¼ˆrwã€group ç­‰ï¼‰
- è¨­å®š symlinkï¼ˆä¾‹å¦‚ /dev/serial â†’ /dev/ttyS0ï¼‰

## cdev vs. udev
| åŠŸèƒ½ | cdev | udev |
| --- | --- | --- |
| å±¤ç´š | Kernel Space | User Space |
| ä½œç”¨ | å»ºç«‹å­—å…ƒè£ç½®çš„ driver è¡Œç‚º (open/read/write) | è‡ªå‹•ç”¢ç”Ÿ /dev node |
| èª°å»ºç«‹ï¼Ÿ | é©…å‹•ç¨‹å¼ä½œè€…åœ¨ module è£¡å»ºç«‹ | Linux ç³»çµ±è‡ªå‹• |
| è² è²¬çš„æ±è¥¿ | VFS è¨»å†Šã€æª”æ¡ˆæ“ä½œå›å‘¼ | /dev nodeã€æ¬Šé™ã€ç¬¦è™Ÿé€£çµ |
| æ˜¯å¦ä¸€å®šè¦ï¼Ÿ | âœ” å¿…è¦ï¼ˆå­—å…ƒè£ç½®ä¸€å®šè¦ cdevï¼‰ | âœ– ä¸ä¸€å®šï¼ˆæ²’æœ‰ udev è¦è‡ªå·± mknodï¼‰ |
| è·Ÿ /sys æœ‰é—œå— | ç„¡é—œï¼ˆä½† device_create æœƒè®“ /sys/class ç”¢ç”Ÿï¼‰ | ä½¿ç”¨ uevent å¾ /sys/class è£¡è®€å–è³‡è¨Š |  



## å¦‚ä½•å‰µå»º /dev/mydevï¼Ÿ
##### - æ–¹æ³•ä¸€ï¼šæ‰‹å‹•å»ºç«‹ï¼ˆä½¿ç”¨ mknodï¼‰
ç”¨ `register_chrdev()` æˆ– `register_chrdev_region()` è¨»å†Šè¨­å‚™å¾Œï¼Œç³»çµ±æœƒçµ¦ä¸€å€‹ä¸»è¨­å‚™è™Ÿï¼ˆmajor numberï¼‰ï¼Œå¯ä»¥æ ¹æ“šé€™å€‹è™Ÿç¢¼æ‰‹å‹•å»ºç«‹ç¯€é»  
mknod	: æ‰‹å‹•å‰µå»ºè£ç½®ç¯€é»ï¼Œéœ€æä¾› major/minor
major/minor	: é©…å‹•èˆ‡è£ç½®çš„å°æ‡‰ç·¨è™Ÿ
##### - æ–¹æ³•äºŒï¼šè‡ªå‹•å»ºç«‹ï¼ˆä½¿ç”¨ udev + class_create/device_createï¼‰
å¯ä»¥é€é `class_create()` æ­é… `device_create()`ï¼Œè®“æ ¸å¿ƒä¸»å‹•é€šçŸ¥ udevï¼ˆä½¿ç”¨è€…ç©ºé–“çš„è£ç½®ç®¡ç†å®ˆè­·ç¨‹å¼ï¼‰ï¼Œè‡ªå‹•å»ºç«‹å°æ‡‰çš„/dev/è£ç½®åç¨± ç¯€é»  
`class_create()`ï¼šå‰µå»ºä¸€å€‹é¡åˆ¥ï¼ˆclassï¼‰ï¼Œä»£è¡¨ä¸€çµ„è£ç½®  
`device_create()`ï¼šå‰µå»ºä¸€å€‹è£ç½®ï¼Œudev æœƒåµæ¸¬åˆ°ä¸¦è‡ªå‹•å»ºç«‹ /dev/mydev  
<br><br>

## å¦‚ä½•å‰µå»º cdevï¼Ÿ

åœ¨ Linux ä¸­ï¼Œcdevï¼ˆcharacter device objectï¼‰æ˜¯ **VFS èˆ‡ä½ çš„ driver ä¹‹é–“çš„çœŸæ­£æ©‹æ¢**ã€‚

è¦è®“ `/dev/mydev` èƒ½å‘¼å«åˆ°ä½ çš„ `open/read/write`ï¼Œå°±éœ€è¦å»ºç«‹ cdevã€‚

å»ºç«‹ cdev ä¹Ÿæœ‰ **å…©ç¨®æ–¹å¼**ï¼š

æ–¹å¼ä¸€ï¼šèˆŠå¼ï¼ˆéš±å«å»ºç«‹ï¼‰

æ–¹å¼äºŒï¼šç¾ä»£æ¨™æº–ï¼ˆæ‰‹å‹•å»ºç«‹ cdevï¼‰ã€‚

---

### æ–¹æ³•ä¸€ï¼šèˆŠå¼å»ºç«‹æ–¹å¼ï¼ˆä½¿ç”¨ register_chrdevï¼‰

#### âœ” ä¸éœ€è¦æ‰‹å‹•å‰µå»º cdev

`register_chrdev()` æœƒï¼š

- åˆ†é… major number
- **è‡ªå‹•å…§éƒ¨å»ºç«‹ä¸€å€‹ cdev**
- å°‡ file_operations ç¶å®šä¸Šå»

#### âœ” ç¼ºé»

- ç„¡æ³•æŒ‡å®š minor numberï¼ˆåªæ”¯æ´ä¸€å€‹ minor=0ï¼‰
- ä¸å¥½ç®¡ç†
- ä¸æ¨è–¦åœ¨åµŒå…¥å¼æˆ–ç”¢å“ä½¿ç”¨ï¼ˆå·²è¢«è¦–ç‚º legacyï¼‰

#### âœ” æµç¨‹ç¤ºæ„

```
register_chrdev()  
   â†“ï¼ˆkernel å…§éƒ¨ auto å»ºç«‹ anonymous cdevï¼‰
å»ºç«‹ cdevï¼ˆkernel è‡ªå‹•ï¼‰
   â†“
ä½ å¯«çš„ open/read/write å°±è¢«æ›ä¸Š
```

### æ–¹æ³•äºŒï¼šç¾ä»£æ¨™æº–æµç¨‹ï¼ˆalloc + cdev_init + cdev_addï¼‰

#### âœ” éœ€è¦ä½ æ‰‹å‹•å»ºç«‹ cdev

ç¾ä»£ Linux driver çš„æ¨™æº–æ–¹æ³•ï¼š

1. **alloc_chrdev_region()**
    
    â†’ åˆ†é… major/minor number
    
2. **cdev_init()**
    
    â†’ åˆå§‹åŒ– cdev objectï¼Œå°‡ file_operations ç¶ä¸Š
    
3. **cdev_add()**
    
    â†’ æ­£å¼æŠŠ cdev è¨»å†Šåˆ° kernelï¼ˆè®“ VFS å¯ä»¥æ“ä½œï¼‰
    

#### âœ” å„ªé»

- å¤šå€‹ minorï¼ˆæ”¯æ´å¤šè£ç½®ï¼‰
- å®Œå…¨æ§åˆ¶ lifecycle
- æ‰€æœ‰æ­£å¼ kernel driver éƒ½ä½¿ç”¨é€™æ–¹å¼ï¼ˆBMC/åµŒå…¥å¼/å¹³å° driver ä¸€å¾‹å¦‚æ­¤ï¼‰

#### âœ” æµç¨‹ç¤ºæ„

```
alloc_chrdev_region()  
   â†“
ä½ å»ºç«‹ struct cdev
   â†“
cdev_init()   â†’ ç¶å®š fops
   â†“
cdev_add()    â†’ æ­£å¼è¨»å†Šé€² kernel
```



## struct file_operations
Linux æ ¸å¿ƒè£¡ç”¨ä¾†å®šç¾©ã€Œé€™å€‹è£ç½®å¯ä»¥åšå“ªäº›æ“ä½œã€çš„çµæ§‹é«”  
ç•¶ä½¿ç”¨è€…å° /dev/è£ç½® åšå‡ºå‹•ä½œï¼ˆå¦‚ catã€echoï¼‰ï¼Œç³»çµ±æœƒå‘¼å«é€™å€‹çµæ§‹è£¡å°æ‡‰çš„å‡½å¼  

<br><br>
<img width="598" height="185" alt="image" src="https://github.com/user-attachments/assets/f726037c-7a70-4350-96fd-6c4c58226bcb" />

-  .owner :è¨­å®šç‚º THIS_MODULEï¼Œä»£è¡¨é€™å€‹çµæ§‹æ˜¯é€™å€‹æ¨¡çµ„çš„ä¸€éƒ¨åˆ†ã€‚é˜²æ­¢æ¨¡çµ„åœ¨ä½¿ç”¨ä¸­è¢«å¸è¼‰  
-  .open :è£ç½®è¢«é–‹å•Ÿæ™‚å‘¼å«ï¼Œä¾‹å¦‚ open("/dev/mydev")  
-  .release : è£ç½®è¢«é—œé–‰æ™‚å‘¼å«ï¼Œä¾‹å¦‚ close(fd)  
-  .read : è£ç½®è¢«è®€å–æ™‚å‘¼å«ï¼Œä¾‹å¦‚ cat /dev/mydev  
-  .write : è£ç½®è¢«å¯«å…¥æ™‚å‘¼å«ï¼Œä¾‹å¦‚ echo hello > /dev/mydev
<br><br>


## é‡è¦æŒ‡ä»¤
#### âœ…`static ssize_t my_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)` 
  - file :ä½¿ç”¨è€…å°è£ç½®é–‹å•Ÿçš„æª”æ¡ˆæè¿°çµæ§‹
  - buf	:ä½¿ç”¨è€…æä¾›çš„ bufferï¼Œè¦æŠŠè³‡æ–™è®€é€²å»ï¼ˆuser spaceï¼‰
  - count :ä½¿ç”¨è€…æƒ³è®€å¤šå°‘ byte
  - ppos :æŒ‡å‘ã€Œç›®å‰è®€å–ä½ç½®ã€çš„åç§»å€¼æŒ‡æ¨™ï¼ˆä½ç§»æŒ‡æ¨™ï¼‰
  - __user ï¼šLinux æ ¸å¿ƒè‡ªå·±å®šç¾©çš„macro,æ¨™è¨»ã€Œé€™å€‹æŒ‡æ¨™æ˜¯æŒ‡å‘ user-space çš„è³‡æ–™ã€
  - loff_t :è¡¨ç¤ºæª”æ¡ˆä½ç§»çš„è³‡æ–™å‹åˆ¥ï¼Œ64 ä½å…ƒæ•´æ•¸ï¼Œæ”¯æ´è¶…é 2GB æª”æ¡ˆçš„ä½ç§»
  - size_t :ç„¡è™Ÿæ•´æ•¸ (ssize_t æ˜¯æœ‰è™Ÿæ•´æ•¸)  

#### âœ…`copy_to_user(buf, device_buffer + *ppos, count)`  
  - copy_to_user() å°‡kernel spaceçš„è³‡æ–™è¤‡è£½åˆ°user spaceçš„ buf
  - å¾ device_buffer + *ppos é–‹å§‹è¤‡è£½ count å€‹ byte

#### âœ…`copy_from_user(device_buffer, user_buf, count)`
  - å°‡user spaceçš„è³‡æ–™è¤‡è£½åˆ°kernel spaceçš„ buf
<img width="478" height="284" alt="image" src="https://github.com/user-attachments/assets/c9bef77d-4d52-49fd-b82c-a1e0ceb0480a" />  

#### âœ…`int register_chrdev(unsigned int major, const char *name, const struct file_operations *fops)`   
  - è¨»å†Šä¸€å€‹ç°¡å–®çš„å­—å…ƒè£ç½®ï¼ˆç„¡éœ€ device classï¼‰
  - majorå‚³å…¥ 0 è¡¨ç¤ºï¼šè«‹æ ¸å¿ƒè‡ªå‹•åˆ†é…ä¸€å€‹ç©ºçš„ä¸»è¨­å‚™è™Ÿï¼ˆmajor numberï¼‰
  - DEVICE_NAMEï¼šæ˜¯é€™å€‹è¨­å‚™çš„åç¨±
  - &fopsæŒ‡å‘ä¸€å€‹ struct file_operations çµæ§‹(open/read/writeï¼‰
  - å›å‚³å€¼ï¼šâ‰¥0ï¼šä»£è¡¨æˆåŠŸï¼Œä¸¦ä¸”æ˜¯åˆ†é…åˆ°çš„ major number ã€‚ <0ï¼šä»£è¡¨å¤±æ•—ï¼Œæœƒæ˜¯ä¸€å€‹éŒ¯èª¤ç¢¼ï¼ˆä¾‹å¦‚ -EBUSY, -ENOMEMï¼‰

#### âœ…`void unregister_chrdev(unsigned int major, const char *name)`  
  - ç§»é™¤å…ˆå‰ç”¨ register_chrdev() è¨»å†Šçš„å­—å…ƒè£ç½®ï¼Œé‡‹æ”¾ä¸»è¨­å‚™è™Ÿï¼Œé¿å…è³‡æºæ´©æ¼
  - å­—å…ƒè£ç½®åç¨±ï¼Œéœ€èˆ‡ register_chrdev() ä½¿ç”¨çš„ç›¸åŒ

#### âœ…`sudo mknod /dev/mydev c 240 0 (mknod [è·¯å¾‘] [é¡å‹] [ä¸»è¨­å‚™è™Ÿ] [æ¬¡è¨­å‚™è™Ÿ])`  
  - /dev/mydevï¼šå»ºç«‹çš„è£ç½®æª”æ¡ˆåç¨±ï¼ˆè£ç½®ç¯€é»æœƒå‡ºç¾åœ¨ /dev/ ä¸‹ï¼‰
  - c :ä»£è¡¨æ˜¯ å­—å…ƒè£ç½®ï¼ˆchar deviceï¼‰ï¼Œä¸æ˜¯ block è£ç½®
  - 240 ï¼šmajor numberï¼Œç”¨ä¾†æŒ‡å®šé€™å€‹è£ç½®è¦äº¤çµ¦å“ªå€‹é©…å‹•è™•ç†ï¼ˆæ¨¡çµ„è£¡ register_chrdev() å›å‚³çš„æ•¸å­—ï¼‰
  - 0 ï¼šminor numberï¼Œé€šå¸¸ç”¨ä¾†å€åˆ†åŒä¸€é¡è£ç½®çš„ä¸åŒå¯¦ä¾‹ï¼Œé€™è£¡è¨­ç‚º 0 å³å¯

#### `dmesg | grep mydev (æŸ¥çœ‹ major number)`




